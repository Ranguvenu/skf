/**
 * Creates the dashbaord widgets for configured widgets on dashboard.
 *
 * @module     block_learnerscript/reportwidget
 * @copyright  2023 Moodle India Information Solutions Private Limited
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_learnerscript/reportwidget",["jquery","core/ajax","block_learnerscript/report","block_learnerscript/smartfilter","core/str","core/templates"],(function($,Ajax,report,smartfilter,Str,Templates){var reportwidget={DashboardWidgets:function(args){var self=this;args=args||{container:".report_dashboard_container"};var filterdata=smartfilter.FilterData(args.reportid);$(".loader").show(),$("#reportcontainer"+args.instanceid).each((function(){var reportid=$(this).data("reportid"),blockinstance=$(this).data("blockinstance");if(""!=$(this).val()){blockinstance=$("#reportcontainer"+undefined).data("blockinstance"),args.reporttype=$("#reporttype_"+blockinstance+"  :selected").val();var params={reportid:reportid,reporttype:args.reporttype};return $.extend(params,filterdata),self.CreateDashboardwidget(params),!1}args.reporttype=$("#reporttype_"+blockinstance+"  :selected").val(),void 0===args.reporttype&&(args.reporttype=$(this).data("reporttype")),self.CreateDashboardwidget({reportid:reportid,reporttype:args.reporttype,instanceid:blockinstance})}))},DashboardTiles:function(){var self=this,lsfstartdate=$("#lsfstartdate").val(),lsfenddate=$("#lsfenddate").val(),courseid=$("#ls_courseid").val();$(".tiles_information").each((function(){self.CreateDashboardTile({blockinstanceid:$(this).data("instanceid"),reportid:$(this).data("reportid"),reporttype:$(this).data("reporttype"),lsfstartdate:lsfstartdate,lsfenddate:lsfenddate,courseid:courseid})}))},CreateDashboardTile:function(args){$("#inst"+args.blockinstanceid+" .tiles_information table tr").html("");var reportinstance=args.blockinstanceid,filters={};filters.lsfstartdate=$("#lsfstartdate"+args.blockinstanceid).val(),filters.lsfenddate=$("#lsfenddate"+args.blockinstanceid).val(),$.urlParam=function(name){var results=new RegExp("[?&]"+name+"=([^&#]*)").exec(window.location.href);return null===results||" "==results?null:results[1]||0};var dashboardurl=$.urlParam("dashboardurl");if(void 0===filters.filter_courses){var filter_courses=$(".report_courses").val();"Course"==dashboardurl&&(args.courseid=filter_courses),1!=filter_courses&&(filters.filter_courses=filter_courses)}Ajax.call([{methodname:"block_learnerscript_generate_plotgraph",args:{instanceid:args.blockinstanceid,reportid:args.reportid,courseid:args.courseid,filters:JSON.stringify(filters),reporttype:args.reporttype},loading:"#reportloading_"+args.blockinstanceid}])[0].done((function(data){data=JSON.parse(data);var tabledata=[];"table"!=args.reporttype?($.extend(data.plot,args),data.plot.container="#plotreportcontainer"+reportinstance,!0===data.plot.error?$("#plotreportcontainer"+reportinstance).html('<p class="alert alert-warning">'+data.plot.messages+"</p>"):0==data.plot.data.length?$(data.plot.container).html("<div class='alert alert-info'>"+data.plot.messages+"</div>"):(data.plot.reportinstance=reportinstance,require(["block_learnerscript/report"],(function(report){report.generate_plotgraph(data.plot)})))):void 0!==data.plot&&(data.plot.data.length>0?($(data.plot.data).each((function(key,value){tabledata=[],tabledata=value.data})),$(data.plot.categorydata).each((function(k,v){1==data.plot.categorydata.length?isNaN(tabledata[0][k])?$("#inst"+args.blockinstanceid+" .tiles_information table tr").append("<td><h6 "+args.styletilescolour+"> "+tabledata[0][k]+" </h6></td>"):$("#inst"+args.blockinstanceid+" .tiles_information table tr").append("<td><h1 "+args.styletilescolour+"> "+tabledata[0][k]+" </h1></td>"):$("#inst"+args.blockinstanceid+" .tiles_information table tr").append("<td>"+v+" : <b> "+tabledata[k]+" </b></td>")}))):(Str.get_string("nodataavailable","block_learnerscript").then((function(s){$("#inst"+args.blockinstanceid+" .tiles_information table tr").html("<div class='alert alert-info'> "+s+"</div>")})),$("#inst"+args.blockinstanceid+" .dashboard_tiles").css("color","#4B4B4B")),$("#reportloading_"+args.blockinstanceid).css("display","none"))}))},CreateDashboardwidget:function(args){0==args.reportdashboard&&(args.instanceid="");var reportinstance=args.instanceid||args.reportid;if(args.filters=args.filters||smartfilter.FilterData(reportinstance),args.columnDefs="",args.filters.lsfstartdate=$("#lsfstartdate"+args.instanceid).val()||$("#lsfstartdate").val(),args.filters.lsfenddate=$("#lsfenddate"+args.instanceid).val()||$("#lsfstartdate").val(),void 0===args.filters.filter_courses){var filter_courses=$(".report_courses").val();1!=filter_courses&&(args.filters.filter_courses=filter_courses)}"table"==args.reporttype||$(".plotgraphcontainer").removeClass("hide").addClass("show"),args.selectreport&&($("#reportcontainer"+reportinstance).attr("data-reporttype",args.singleplot),$("#plotreportcontainer"+reportinstance).attr("data-reporttype",args.singleplot),delete args.selectreport),args.filters=JSON.stringify(args.filters),args.action="generate_plotgraph",$(".download_menu"+reportinstance+" li a").each((function(){var link=$(this).attr("href");if(void 0!==args.basicparams){var basicparamsdata=JSON.parse(args.basicparams);$.each(basicparamsdata,(function(key,value){0==key.indexOf("filter_")&&(link+="&"+key+"="+value)}))}if(void 0!==args.filters){var filters=JSON.parse(args.filters);$.each(filters,(function(key,value){0==key.indexOf("filter_")&&(link+="&"+key+"="+value)}))}$(this).attr("href",link)})),args.basicparams=args.basicparams||JSON.stringify(smartfilter.BasicparamsData(reportinstance)),void 0!==args.reportdashboard&&void 0!==args.reporttype?($("#reportcontainer"+reportinstance).html(""),$("#plotreportcontainer"+reportinstance).html("")):void 0!==args.reportdashboard&&"table"==args.reporttype?$("#reportcontainer"+reportinstance).html(""):$("#plotreportcontainer"+reportinstance).html("");var promise=Ajax.call([{methodname:"block_learnerscript_generate_plotgraph",args:args,loading:"#reportloading_"+args.reportid}]);$("#reportloadingimage").length<=0&&("table"==args.reporttype?$("#reportcontainer"+args.reportid).prepend('<img src="'+M.util.image_url("loading","block_learnerscript")+'" id="reportloadingimage" />'):$("#plotreportcontainer"+args.reportid).prepend('<img src="'+M.util.image_url("loading","block_learnerscript")+'" id="reportloadingimage" />')),promise[0].done((function(chartdata){"table"==((chartdata=$.parseJSON(chartdata)).reporttype||args.reporttype)?void 0===chartdata.data&&chartdata.emptydata?($("#reporttable_"+args.reportid).length||Str.get_string("nodataavailable","block_learnerscript").then((function(s){$("#reportcontainer"+reportinstance).html('<p class="alert alert-info">'+s+"</p>")})),$(document).ajaxStop((function(){$("#reportloadingimage").remove()}))):Templates.render("block_learnerscript/reporttable",chartdata.tdata).done((function(html){$("#reporttable_"+args.reportid).length||$("#reportcontainer"+reportinstance).html(html),$(document).ajaxStop((function(){$("#reportloadingimage").remove()})),args.columnDefs=chartdata.columnDefs,args.data=chartdata.data,args.reportname=chartdata.reportname,require(["block_learnerscript/report"],(function(report){report.ReportDatatable(args)}))})):($.extend(chartdata.plot,args),chartdata.plot.container="#plotreportcontainer"+reportinstance,$(document).ajaxStop((function(){$("#reportloadingimage").remove()})),!0===chartdata.plot.error?$("#plotreportcontainer"+reportinstance).html('<p class="alert alert-warning">'+chartdata.plot.messages+"</p>"):chartdata.plot.data&&chartdata.plot.data.length>0?(chartdata.plot.reportinstance=reportinstance,$(".drilldown"+reportinstance+" .ui-dialog-title").html(chartdata.reportname),args.reportname=chartdata.reportname,require(["block_learnerscript/report"],(function(report){report.generate_plotgraph(chartdata.plot)}))):Str.get_string("nodataavailable","block_learnerscript").then((function(s){$(chartdata.plot.container).html('<p class="alert alert-warning">'+s+"</p>")})))})).fail((function(){}))}};return reportwidget}));

//# sourceMappingURL=reportwidget.min.js.map