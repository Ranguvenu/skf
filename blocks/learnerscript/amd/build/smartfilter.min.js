/**
 * This prevents time being wasted on preparing information for filters that they do not need.
 *
 * @module     block_learnerscript/smartfilter
 * @copyright  2023 Moodle India Information Solutions Private Limited
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_learnerscript/smartfilter",["jquery","block_learnerscript/ajax","block_learnerscript/reportwidget","block_learnerscript/report","block_learnerscript/flatpickr","block_learnerscript/serialize/jquery.serialize-object","core/str"],(function($,ajax,reportwidget,report,flatpickr,serialize,str){var BasicparamUser=$(".basicparamsform #id_filter_users"),BasicparamActivity=$(".basicparamsform #id_filter_activities"),FilterUser=$(".filterform #id_filter_users"),FilterActivity=$(".filterform #id_filter_activities"),selectduration=$(".durationfilter"),reportcontenttype=$(".reportcontenttype"),smartfilter={SelectDuration:function(){var self=this;selectduration.on("click",(function(e){e.stopImmediatePropagation();var instanceid=$(this).data("blockinstance"),reportid=$(this).data("reportid"),reporttype=$(this).data("reporttype"),duration=$(this).data("duration");self.DurationFilter(duration,"true",reportid,instanceid,reporttype),$("#reportcontainer"+instanceid).html().length>0?$("#plotreportcontainer"+instanceid).data("reporttype",reporttype):$("#reportcontainer"+instanceid).data("reporttype",reporttype),$("#datefilter"+instanceid).trigger("click")}))},ReportContenttypes:function(){reportcontenttype.on("click",(function(e){e.stopImmediatePropagation(),$(".navbar-collapse").collapse("hide");var instanceid=$(this).data("blockinstance"),reportid=$(this).data("reportid"),reporttype=$(this).data("reporttype");require(["block_learnerscript/reportwidget"],(function(reportwidget){reportwidget.CreateDashboardwidget({reporttype:reporttype,container:"#reporttype_"+instanceid,reportid:reportid,instanceid:instanceid,reportdashboard:1,selectreport:!0})})),$("#reportcontainer"+instanceid).html().length>0?$("#plotreportcontainer"+instanceid).data("reporttype",reporttype):$("#reportcontainer"+instanceid).data("reporttype",reporttype),$("#reportcontenttypes"+instanceid).trigger("click")}))},DurationFilter:function(value,reportdashboard){let report1id=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,instanceid=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,reportcontenttype=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;var today=new Date,start_duration="";if(0==reportdashboard&&(instanceid=""),"clear"!==value){switch($("#lsfenddate"+instanceid).val(today.getTime()/1e3),value){case"week":start_duration=new Date(today.getFullYear(),today.getMonth(),today.getDate()-7);break;case"month":start_duration=new Date(today.getFullYear(),today.getMonth()-1,today.getDate());break;case"year":start_duration=new Date(today.getFullYear()-1,today.getMonth(),today.getDate());break;case"custom":var reportid=$('input[name="reportid"]').val();$("#customrange"+instanceid).show(),flatpickr("#customrange"+instanceid,{mode:"range",onOpen:function(selectedDates,dateStr,instance){instance.clear()},onClose:function(selectedDates,dateStr){$("#lsfstartdate"+instanceid).val(selectedDates[0].getTime()/1e3),$("#lsfenddate"+instanceid).val(selectedDates[1].getTime()/1e3+86400),0==reportdashboard?require(["block_learnerscript/report"],(function(report){report.CreateReportPage({reportid:reportid,instanceid:instanceid,reportdashboard:reportdashboard})})):require(["block_learnerscript/report"],(function(report){report.CreateReportPage({reportid:report1id,instanceid:instanceid,reportdashboard:reportdashboard})})),$("#durtiontext"+instanceid).text(dateStr)}});break;default:$("#lsfstartdate"+instanceid).val(0)}""!=start_duration&&$("#lsfstartdate"+instanceid).val(start_duration.getTime()/1e3)}else $("#lsfenddate"+instanceid).val(""),$("#lsfstartdate"+instanceid).val("");if("custom"!==value){if(0!=reportdashboard)require(["block_learnerscript/reportwidget"],(function(reportwidget){reportwidget.CreateDashboardwidget({reportid:report1id,reporttype:reportcontenttype,instanceid:instanceid})})),str.get_string(value,"block_reportdashboard").then((function(s){$("#durtiontext"+instanceid).text(s)}));else{reportid=$('input[name="reportid"]').val();require(["block_learnerscript/report"],(function(report){report.CreateReportPage({reportid:reportid,instanceid:reportid,reportdashboard:reportdashboard})}))}$("#customrange"+instanceid).val(""),$("#customrange"+instanceid).hide()}if(1!=reportdashboard){reportid=$('input[name="reportid"]').val();$(".plotgraphcontainer").removeClass("show").addClass("hide"),$("#plotreportcontainer"+reportid).html("")}},FilterData:function(reportinstance){var reportfilter=$(".filterform"+reportinstance).serializeObject();if($.urlParam=function(name){var results=new RegExp("[?&]"+name+"=([^&#]*)").exec(window.location.href);return null===results||" "==results?null:results[1]||0},"Course"==$.urlParam("dashboardurl")){var filter_courseid=$(".report_courses").val();reportfilter.filter_courses=filter_courseid}return reportfilter},BasicparamsData:function(reportinstance){return $(".basicparamsform"+reportinstance).serializeObject()},CourseData:function(args){var FirstElementActive=!1;(BasicparamActivity.length>0||FilterActivity.length>0)&&(BasicparamActivity.length>0&&(FirstElementActive=!0),args.courseid>0&&this.CourseActivities({courseid:args.courseid,firstelementactive:FirstElementActive,activityid:args.filterrequests.filter_activities})),(BasicparamUser.length>0||FilterUser.length>0)&&BasicparamUser.length>0&&(FirstElementActive=!0)},categoryCourses:function(args){$("#id_filter_coursecategories").find(":selected").val()>0&&ajax.call({args:{action:"categorycourses",basicparam:!0,reporttype:args.reporttype,categoryid:args.categoryid},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done((function(response){var template="";$.each(response,(function(key,value){template+="<option value = "+key+">"+value+"</option>"})),$("#id_filter_courses").html(template)}))},CourseActivities:function(args){var currentcourse=$("#id_filter_courses").find(":selected").val(),requestedactivityid=args.activityid;currentcourse>0&&ajax.call({args:{action:"courseactivities",basicparam:!0,courseid:args.courseid},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done((function(response){var template="";$.each(response,(function(key,value){var selected="";key==requestedactivityid&&(selected="selected"),template+="<option value = "+key+" "+selected+" >"+value+"</option>"})),$("#id_filter_activities").html(template);var currentactivity=$(".basicparamsform #id_filter_activities").find(":selected").val();0!=currentactivity&&null!==currentactivity||$(".basicparamsform #id_filter_activities").val($(".basicparamsform #id_filter_activities option:eq(1)").val()),$("#id_filter_activities").trigger("change")}))},UserCourses:function(args){var currentcourse=$("#id_filter_courses").find(":selected").val();($("#id_filter_courses").find("option").remove().end().append('<option value="">'+str.get_string("filter_course","block_learnerscript").then((function(s){return s}))+"</option>"),args.userid>=0)&&ajax.call({args:{action:"usercourses",basicparam:!0,userid:args.userid,reporttype:args.reporttype,reportid:args.reportid},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done((function(response){$.each(response,(function(key,value){if(0==key)return!0;key==Object.keys(response)[0]&&1==args.firstelementactive||key==currentcourse&&1==args.firstelementactive?($("#id_filter_courses").append($("<option></option>").attr("value",key).attr("selected","selected").text(value)),void 0!==args.triggercourseactivities&&1==args.triggercourseactivities&&smartfilter.CourseActivities({courseid:key})):$("#id_filter_courses").append($("<option></option>").attr("value",key).text(value))}))}))},EnrolledUsers:function(args){var nearelement=args.element||$("#id_filter_users"),currentuser=nearelement.val();nearelement.find("option").remove().end().append('<option value="">'+str.get_string("filter_user","block_learnerscript").then((function(s){return s}))+"</option>"),ajax.call({args:{action:"enrolledusers",basicparam:!0,reportid:args.reportid,courseid:args.courseid,reporttype:args.reporttype,component:args.components},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done((function(response){($.each(response,(function(key,value){if(0==key)return!0;key!=currentuser?nearelement.append($("<option></option>").attr("value",key).text(value)):nearelement.append($("<option></option>").attr("value",key).attr("selected","selected").text(value))})),response.hasOwnProperty(currentuser))&&(nearelement.select2("val",""),nearelement.parents(".basicparamsform").length>0&&args.onloadtrigger&&$(".basicparamsform #id_filter_apply").trigger("click"))}))},CohortUsers:function(args){$("#id_filter_cohort").find(":selected").val()>0&&ajax.call({args:{action:"cohortusers",basicparam:!0,reporttype:args.reporttype,categoryid:args.cohortid},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done((function(response){var template="";$.each(response,(function(key,value){template+="<option value = "+key+">"+value+"</option>"})),$("#id_filter_users").html(template)}))}};return smartfilter}));

//# sourceMappingURL=smartfilter.min.js.map