define("block_learnerscript/report",["jquery","block_learnerscript/select2/select2","block_learnerscript/datatables/jquery.dataTables","block_learnerscript/datatables/responsive.bootstrap","block_learnerscript/reportwidget","block_learnerscript/chart","block_learnerscript/smartfilter","block_learnerscript/schedule","block_learnerscript/helper","block_learnerscript/ajaxforms","block_learnerscript/ajax","block_learnerscript/radioslider/jquery.radios-to-slider","block_learnerscript/flatpickr","core/templates","core/str","jqueryui"],(function($,select2,dataTable,responsive,reportwidget,chart,smartfilter,schedule,helper,AjaxForms,ajax,RadiosToSlider,flatpickr,templates,Str){var BasicparamCourse=$(".basicparamsform #id_filter_courses"),BasicparamUser=$(".basicparamsform #id_filter_users"),BasicparamActivity=$(".basicparamsform #id_filter_activities"),FilterCourse=$(".filterform #id_filter_courses"),FilterUser=$(".filterform #id_filter_users"),FilterActivity=$(".filterform #id_filter_activities"),FilterModule=$(".filterform #id_filter_modules"),FilterCohort=$(".filterform #id_filter_cohort"),NumberOfBasicParams=0,report={init:function(args){if($.ui.dialog.prototype._focusTabbable=$.noop,$.fn.dataTable.ext.errMode="none",$(".plotgraphcontainer").on("click",(function(){var reportid=$(this).data("reportid");$(".plotgraphcontainer").removeClass("show").addClass("hide"),$("#plotreportcontainer"+reportid).html("")})),$(document).on("click",".sendusermsg",(function(e){var userid=$(this).data("userid"),reportinstance=$(this).data("reportinstance"),userfullname=$(this).data("userfullname");helper.sendmessage({userid:userid,reportinstance:reportinstance},userfullname),e.stopImmediatePropagation()})),$(document).on("click",".ls-plotgraph_link",(function(){var reportid=$(this).data("reportid"),reporttype=$(this).data("reporttype");reportwidget.CreateDashboardwidget({reportid:reportid,reporttype:reporttype})})),$(document).on("click",".calenderdatefilter",(function(){var activefilter=$(this).data("activefilter"),inactivefilter=$(this).data("inactivefilter");helper.ViewReportFilters({activefilter:activefilter,inactivefilter:inactivefilter})})),$(document).on("click",".customfiltericon",(function(){var activefilter=$(this).data("activefilter"),inactivefilter=$(this).data("inactivefilter");helper.ViewReportFilters({activefilter:activefilter,inactivefilter:inactivefilter})})),$(document).on("click",".statisticshelptext",(function(){var reportid=$(this).data("reportid");report.block_statistics_help(reportid)})),$(document).on("click",".ls-plotreport_editicon",(function(){var reportid=$(this).data("reportid"),action=$(this).data("action"),component=$(this).data("component"),title=$(this).data("title"),pname=$(this).data("pname"),cid=$(this).data("cid"),type=$(this).data("type");helper.PlotForm({reportid:reportid,action:action,component:component,title:title,pname:pname,cid:cid,type:type})})),$(document).on("click",".ls-plotreport_deleteicon",(function(){var reportid=$(this).data("reportid"),pname=$(this).data("pname"),cid=$(this).data("cid"),gdelete=$(this).data("delete"),comp=$(this).data("comp"),action=$(this).data("graphaction");helper.deleteConfirm({reportid:reportid,action:action,comp:comp,pname:pname,cid:cid,delete:gdelete})})),$(document).on("click",".plotgraphoptions",(function(){alert(34);var reportid=$(this).data("reportid"),action=$(this).data("action"),component=$(this).data("component"),title=$(this).data("title"),pname=$(this).data("pname"),type=$(this).data("type");helper.PlotForm({reportid:reportid,action:action,component:component,title:title,pname:pname,type:type})})),$("select[data-select2='1']").select2({theme:"classic"}).on("select2:selecting",(function(e){$(this).val()&&$(this).data("maximumselectionlength")&&$(this).val().length>=$(this).data("maximumselectionlength")&&(e.preventDefault(),$(this).select2("close"))})),$("#reportsearch").val(args.reportid).trigger("change.select2"),$("#reportsearch").change((function(){var reportid=$(this).find(":selected").val();window.location=M.cfg.wwwroot+"/blocks/learnerscript/viewreport.php?id="+reportid})),RadiosToSlider.init($("#segmented-button"),{size:"medium",animation:!0,reportdashboard:!1}),flatpickr("#customrange",{mode:"range",onOpen:function(selectedDates,dateStr,instance){instance.clear()},onClose:function(selectedDates){0!==selectedDates.length&&($("#lsfstartdate").val(selectedDates[0].getTime()/1e3),$("#lsfenddate").val(selectedDates[1].getTime()/1e3+86400),require(["block_learnerscript/report"],(function(report){report.CreateReportPage({reportid:args.reportid,instanceid:args.reportid,reportdashboard:!1})})))}}),$("#id_filter_cohort").change((function(){var cohortid=$(this).find(":selected").val();cohortid>0&&(FilterUser.length>0||BasicparamUser.length>0)&&(BasicparamUser.length>0&&(FirstElementActive=!0),smartfilter.CohortUsers({cohortid:cohortid,reporttype:args.reporttype,reportid:args.reportid,firstelementactive:FirstElementActive}))})),void 0===BasicparamCourse&&void 0===FilterCourse||$("#id_filter_courses").change((function(){args.courseid=$(this).find(":selected").val(),smartfilter.CourseData(args)})),$("#id_filter_users").change((function(){$(this).find(":selected").val()>0&&(FilterCourse.length>0||BasicparamCourse.length>0)&&BasicparamCourse.length>0&&(FirstElementActive=!0)})),$("#id_filter_coursecategories").change((function(){var categoryid=$(this).find(":selected").val();smartfilter.categoryCourses({categoryid:categoryid,reporttype:args.reporttype})})),schedule.SelectRoleUsers(),null!==args.basicparams&&"courses"==args.basicparams[0].name&&($("#id_filter_courses").trigger("change"),NumberOfBasicParams++),null!==args.basicparams){var FirstElementActive=!1;if("users"==args.basicparams[0].name)BasicparamCourse.length>0&&(FirstElementActive=!0),$("#id_filter_users").find(":selected").val()>0&&(args.courseid=$("#id_filter_courses").find(":selected").val(),smartfilter.CourseData(args))}$(".filterform"+args.reportid+" .fitemtitle").hide(),$(".filterform"+args.reportid+" .felement").attr("style","margin:0"),$(".basicparamsform"+args.reportid+" .fitemtitle").hide(),$(".basicparamsform"+args.reportid+" .felement").attr("style","margin:0"),$(".filterform #id_filter_clear").click((function(){$(".filterform"+args.reportid).trigger("reset"),FilterUser.length>0&&(FilterCourse.length>0||BasicparamCourse.length>0)&&BasicparamCourse.length>0&&(FirstElementActive=!0),FilterCourse.length>0&&(FilterUser.length>0||BasicparamUser.length,(FilterActivity.length>0||BasicparamActivity.length>0)&&smartfilter.CourseActivities({courseid:0})),(FilterActivity.length>0||FilterModule.length>0)&&((FilterCourse.length>0||BasicparamCourse.length>0)&&0==BasicparamUser.length&&BasicparamCourse.length>0&&0==BasicparamUser.length&&(FirstElementActive=!0),BasicparamCourse.length>0&&BasicparamUser.length>0&&$(".basicparamsform #id_filter_apply").trigger("click",[!0])),FilterCohort.length>0&&FilterUser.length>0&&smartfilter.CohortUsers({cohortid:0}),$(".basicparamsform #id_filter_apply").length>0?($(document).ajaxComplete((function(){})),$(".basicparamsform #id_filter_apply").trigger("click",[!0])):(args.reporttype=$(".ls-plotgraphs_listitem.ui-tabs-active").data("cid"),report.CreateReportPage({reportid:args.reportid,reporttype:args.reporttype,instanceid:args.reportid,reportdashboard:!1})),$(".filterform select[data-select2='1']").select2("destroy").select2({theme:"classic"}),$(".filterform select[data-select2-ajax='1']").val("0").trigger("change"),$(".filterform")[0].reset(),$(".filterform #id_filter_clear").attr("disabled","disabled"),$(".plotgraphcontainer").removeClass("show").addClass("hide"),$("#plotreportcontainer"+args.instanceid).html("")})),$(".basicparamsform #id_filter_apply,.filterform #id_filter_apply").click((function(e,validate){var getreport=helper.validatebasicform(validate);e.preventDefault(),e.stopImmediatePropagation(),$(".filterform"+args.reportid).show(),args.instanceid=args.reportid,"Get Report"!=e.currentTarget.value&&$(".filterform #id_filter_clear").removeAttr("disabled"),-1!=$.inArray(0,getreport)?($("#report_plottabs").hide(),Str.get_string("nodataavailable","block_learnerscript").then((function(s){$("#reportcontainer"+args.reportid).html("<div class='alert alert-info'>"+s+"</div>")}))):($("#report_plottabs").show(),args.reporttype=$(".ls-plotgraphs_listitem.ui-tabs-active").data("cid"),report.CreateReportPage({reportid:args.reportid,reporttype:args.reporttype,instanceid:args.instanceid,reportdashboard:!1})),$(".plotgraphcontainer").removeClass("show").addClass("hide"),$("#plotreportcontainer"+args.instanceid).html("")})),null===args.basicparams?report.CreateReportPage({reportid:args.reportid,reporttype:args.reporttype,instanceid:args.reportid,reportdashboard:!1}):args.basicparams.length<=4?$(".basicparamsform #id_filter_apply").trigger("click",[!0]):$(document).ajaxComplete((function(event,xhr,settings){if(settings.url.indexOf("blocks/learnerscript/ajax.php")>0){if(void 0!==settings.data){var ajaxaction=$.parseJSON(settings.data);void 0!==ajaxaction.basicparam&&1==ajaxaction.basicparam&&NumberOfBasicParams++}args.basicparams.length==NumberOfBasicParams&&"plotforms"!=ajaxaction.action&&"pluginlicence"!=ajaxaction.action&&$(".basicparamsform #id_filter_apply").trigger("click",[!0])}}))},CreateReportPage:function(args){var disabletable=0;0==args.reportdashboard&&((disabletable=$("#disabletable").val())&&(args.reporttype=$($(".ls-plotgraphs_listitem")[0]).data("cid")));1==disabletable&&args.reporttype.length>0?chart.HighchartsAjax({reportid:args.reportid,action:"generate_plotgraph",cols:args.cols,reporttype:args.reporttype}):0==disabletable&&require(["block_learnerscript/reportwidget"],(function(reportwidget){reportwidget.CreateDashboardwidget({reportid:args.reportid,reporttype:"table",instanceid:args.instanceid,reportdashboard:args.reportdashboard})}))},generate_plotgraph:function(response){if(response){var reportinstance=response.reportinstance||response.reportid;switch(response.containerid="plotreportcontainer"+reportinstance,response.type){case"spline":case"bar":case"column":chart.lbchart(response);break;case"radar":chart.radarchart(response);break;case"combination":chart.combinationchart(response);break;case"pie":chart.piechart(response)}}},ReportDatatable:function(args){Str.get_strings([{key:"show",component:"block_learnerscript"},{key:"show_all",component:"block_learnerscript"},{key:"nodataavailable",component:"block_learnerscript"},{key:"search",component:"block_learnerscript"}]).then((function(s){var params={},reportinstance=args.instanceid?args.instanceid:args.reportid;if(params.filters=args.filters,params.basicparams=args.basicparams||JSON.stringify(smartfilter.BasicparamsData(reportinstance)),params.reportid=args.reportid,params.columns=args.columns,$.fn.dataTable.pipeline=function(opts){var conf=$.extend({url:"",data:null,method:"POST"},opts);return function(request,drawCallback,settings){var json,requestStart=request.start,requestLength=request.length;void 0!==args.data&&1==request.draw?((json=args.data).draw=request.draw,json.data.splice(0,requestStart),json.data.splice(requestLength,json.data.length),drawCallback(json)):(request.start=requestStart,request.length=requestLength,$.extend(request,conf.data),settings.jqXHR=$.ajax({type:conf.method,url:conf.url,data:request,dataType:"json",cache:!1,success:function(json){drawCallback(json)}}))}},"Users profile"==args.reportname||"Course profile"==args.reportname)var lengthoptions=[[50,100,-1],[s[0]+"50",s[0]+"100",s[1]]];else lengthoptions=[[10,25,50,100,-1],[s[0]+"10",s[0]+"25",s[0]+"50",s[0]+"100",s[1]]];$("#reporttable_"+reportinstance).DataTable({processing:!0,serverSide:!0,destroy:!0,dom:'<"co_report_header"Bf <"report_header_skew"  <"report_header_skew_content" Bl<"report_header_showhide" ><"report_calculation_showhide" >> > > tr <"co_report_footer"ip>',ajax:$.fn.dataTable.pipeline({type:"POST",url:M.cfg.wwwroot+"/blocks/learnerscript/components/datatable/server_processing.php?sesskey="+M.cfg.sesskey,data:params}),columnDefs:args.columnDefs,fnDrawCallback:function(){helper.DrilldownReport()},oScroll:{},responsive:!0,fnInitComplete:function(){"Users profile"!=args.reportname&&"Course profile"!=args.reportname&&"Statistic"!=args.reportname||($("#reporttable_"+reportinstance+"_wrapper .co_report_header").remove(),$("#reporttable_"+reportinstance+"_wrapper .co_report_footer").remove()),$(".download_menu"+reportinstance+" li a").each((function(){var link=$(this).attr("href");if(void 0!==args.basicparams){var basicparamsdata=JSON.parse(args.basicparams);$.each(basicparamsdata,(function(key,value){0==key.indexOf("filter_")&&(link+="&"+key+"="+value)}))}if(void 0!==args.filters){var filters=JSON.parse(args.filters);$.each(filters,(function(key,value){0==key.indexOf("filter_")&&(link+="&"+key+"="+value),0==key.indexOf("lsf")&&(link+="&"+key+"="+value)}))}$(this).attr("href",link)}))},fnRowCallback:function(nRow){return $(nRow).children().each((function(index,td){$(td).css("word-break",args.columnDefs[index].wrap),$(td).css("width",args.columnDefs[index].width)})),nRow},autoWidth:!1,aaSorting:[],language:{paginate:{previous:"<",next:">"},sProcessing:"<img src='"+M.util.image_url("loading","block_learnerscript")+"'>",search:"_INPUT_",searchPlaceholder:s[3],lengthMenu:"_MENU_",emptyTable:"<div class='alert alert-info'>"+s[2]+"</div>"},lengthMenu:lengthoptions}),$(".drilldown"+reportinstance+" .ui-dialog-title").html(args.reportname),$("#page-blocks-learnerscript-viewreport #reporttable_"+args.reportid+"_wrapper div.report_header_showhide").html($("#export_options"+args.reportid).html()),$(".reportcalculation"+args.reportid).length>0&&$("#page-blocks-learnerscript-viewreport #reporttable_"+args.reportid+"_wrapper div.report_calculation_showhide").html('<img src="'+M.util.image_url("calculationicon","block_learnerscript")+"\" onclick=\"(function(e){ require('block_learnerscript/helper').reportCalculations({reportid:"+args.reportid+'}) })(event)" title ="Calculations" />')}))},AddExpressions:function(e,value){$(e.target).on("select2:unselecting",(function(e){$("#fitem_id_"+e.params.args.data.id).remove()}));var columns=$(e.target).val();$.each(columns,(function(index){if(!($("#fitem_id_"+columns[index]).length>0)){var column=[];column.name=columns[index],column.conditionsymbols=[];$.each(["=",">","<",">=","<=","<>"],(function(index,value){column.conditionsymbols.push({value:value})}));var requestdata={column:column};templates.render("block_learnerscript/plotconditions",requestdata).then((function(html){"yaxisbarvalue"==value?$("#yaxis_bar1").append(html):$("#yaxis1").append(html)})).fail((function(){}))}}))},block_statistics_help:function(reportid){ajax.call({args:{action:"learnerscriptdata",reportid:reportid},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done((function(response){require(["core/modal_factory"],(function(ModalFactory){ModalFactory.create({title:response.name,body:response.summary,footer:""}).done((function(modal){var dialogue=modal,ModalEvents=require("core/modal_events");dialogue.getRoot().on(ModalEvents.hidden,(function(){})),dialogue.show()}))}))}))},CourseprofileReportsdata:function(args){"table"==args.reporttype?reportwidget.CreateDashboardwidget({reportid:args.reportid,reporttype:"table",instanceid:args.instanceid,reportdashboard:args.reportdashboard,filters:args.filters}):chart.HighchartsAjax({reportid:args.reportid,action:"generate_plotgraph",cols:args.cols,reporttype:args.reporttype,filters:args.filters})}};return report}));

//# sourceMappingURL=report.min.js.map