/**
 * Schedule a timings on a calender.
 *
 * @module     block_learnerscript/schedule
 * @copyright  2023 Moodle India Information Solutions Private Limited
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_learnerscript/schedule",["jquery","core/ajax","block_learnerscript/ajax","core/event","block_learnerscript/select2/select2","block_learnerscript/report","core/str","core/templates"],(function($,Ajax,ajax,Event,select2,report,Str,Templates){var schedule={schreportform:function(args){Ajax.call([{methodname:"block_learnerscript_schreportform",args:{reportid:args.reportid,instance:args.instanceid}}])[0].done((function(response){response=$.parseJSON(response),$("body").append("<div class='schreportform"+args.instanceid+"'>"+response+"</div>");var title_img="<img class='dialog_title_icon' alt='Scheduled Report' src='"+M.util.image_url("schedule_icon","block_learnerscript")+"'/>";Str.get_strings([{key:"add_scheduled_report",component:"block_learnerscript"},{key:"close",component:"block_learnerscript"},{key:"schedule_report",component:"block_learnerscript"}]).then((function(s){$(".schreportform"+args.instanceid).dialog({resizable:!0,autoOpen:!1,width:"90%",title:s[0],modal:!0,appendTo:"#inst"+args.instanceid,position:{my:"center",at:"center",of:"#reportcontainer"+args.instanceid},open:function(){$(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var Closebutton=$(".ui-icon-closethick").parent();$(Closebutton).attr({title:s[1]}),$(this).closest(".ui-dialog").find(".ui-dialog-title").html(title_img+"Schedule report")},close:function(){$(this).dialog("destroy").remove()}});$(".schreportform"+args.instanceid).dialog({resizable:!0,autoOpen:!1,width:"90%",title:s[0],modal:!0,appendTo:"#inst"+args.instanceid,position:{my:"center",at:"center",of:"#reportcontainer"+args.instanceid},open:function(){$(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var Closebutton=$(".ui-icon-closethick").parent();$(Closebutton).attr({title:s[1]}),$(this).closest(".ui-dialog").find(".ui-dialog-title").html(title_img+s[2])},close:function(){$(this).dialog("destroy").remove()}}).dialog("open")})),$("#id_role"+args.instanceid).select2(),this.SelectRoleUsers(),this.schformvalidation({reportid:args.reportid,form:"schform"+args.instanceid,reqclass:"schformreq"+args.instanceid,instanceid:args.instanceid})})).fail((function(){}))},ScheduledTimings:function(args){$("select[data-select2='1']").select2({theme:"classic"}),this.SelectRoleUsers(),Str.get_strings([{key:"filter_all",component:"block_learnerscript"}]).then((function(s){$("#scheduledtimings").dataTable({processing:!0,serverSide:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,s[0]]],idisplaylength:5,ordering:!1,ajax:{method:"GET",url:M.cfg.wwwroot+"/blocks/learnerscript/components/scheduler/ajax.php",data:args}})})),$(document).on("change",".schuserroleslist",(function(){var reportid=$(this).data("reportid"),reportinstance=$(this).data("reportinstance");schedule.rolewiseusers({reportid:reportid,reportinstance:reportinstance})})),$(document).on("change",".schusers_data",(function(){var reportid=$(this).data("reportid"),reportinstance=$(this).data("reportinstance");schedule.addschusers({reportid:reportid,reportinstance:reportinstance})})),$(document).on("change","select[name='frequency']",(function(){var reportid=$(this).data("reportid"),reportinstance=$(this).data("reportinstance");schedule.frequency_schedule({reportid:reportid,reportinstance:reportinstance})}))},ViewSchUsersTable:function(args){Str.get_strings([{key:"filter_all",component:"block_learnerscript"}]).then((function(s){$("#scheduledusers").dataTable({processing:!0,serverSide:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,s[0]]],idisplaylength:5,ordering:!1,ajax:{method:"GET",url:M.cfg.wwwroot+"/blocks/learnerscript/components/scheduler/ajax.php",data:{action:"viewschusersdata",reportid:args.reportid,scheduleid:args.scheduleid,schuserslist:args.schuserslist}}})}))},schformvalidation:function(args){document.getElementById(args.form).addEventListener("submit",(function(ev){try{var myValidator=report.validate_scheduled_reports_form(args)}catch(e){return!0}return void 0!==window.tinyMCE&&window.tinyMCE.triggerSave(),myValidator||ev.preventDefault(),!1}))},validate_scheduled_reports_form:function(args){var self=this;var ret=!0,first_focus=!1;return $("[data-class='"+args.reqclass+"']").each((function(index,value){var element=$(value).data("element");(ret=self.validate_scheduled_reports_form_element(value,element,args)&&ret)||first_focus||(first_focus=!0,Y.use("moodle-core-event",(function(){Y.Global.fire(M.core.globalEvents.FORM_ERROR,{formid:args.form,elementid:"id_error_"+element+args.instanceid}),document.getElementById("id_error_"+element+args.instanceid).focus()})))})),ret},validate_scheduled_reports_form_element:function(element,escapedName,args){if(null==element)return!0;var value="",errFlag=new Array,_qfMsg="",frm=element.parentNode;if(null!=element.name&&null!=frm){for(;frm&&"FORM"!=frm.nodeName.toUpperCase();)frm=frm.parentNode;value=new Array;for(var valueIdx=0,i=0;i<element.options.length;i++)element.options[i].selected&&(value[valueIdx++]=element.options[i].value);return""!=value||errFlag[escapedName]||(errFlag[escapedName]=!0,Str.get_string("supplyvalue","block_learnerscript").then((function(s){_qfMsg+=s}))),this.qf_errorHandler(element,_qfMsg,escapedName,args)}return!0},qf_errorHandler:function(element,_qfMsg,escapedName,args){var event=$.Event(Event.Events.FORM_FIELD_VALIDATION);if($(element).trigger(event,_qfMsg),event.isDefaultPrevented())return""==_qfMsg;var div=element.parentNode;if(null==div||null==element.name)return!0;if(""!=_qfMsg){var errorSpan;for((errorSpan=document.getElementById("id_error_"+escapedName+args.instanceid))||((errorSpan=document.createElement("span")).id="id_error_"+escapedName+args.instanceid,errorSpan.className="error",element.parentNode.insertBefore(errorSpan,element.parentNode.firstChild),document.getElementById(errorSpan.id).setAttribute("TabIndex","0"),document.getElementById(errorSpan.id).focus());errorSpan.firstChild;)errorSpan.removeChild(errorSpan.firstChild);return errorSpan.appendChild(document.createTextNode(_qfMsg.substring(3)))," error"!=div.className.substr(div.className.length-6,6)&&"error"!=div.className&&(div.className+=" error",(linebreak=document.createElement("br")).className="error",linebreak.id="id_error_break_"+escapedName+args.instanceid,errorSpan.parentNode.insertBefore(linebreak,errorSpan.nextSibling)),!1}(errorSpan=document.getElementById("id_error_"+escapedName+args.instanceid))&&errorSpan.parentNode.removeChild(errorSpan);var linebreak=document.getElementById("id_error_break_"+escapedName+args.instanceid);return linebreak&&linebreak.parentNode.removeChild(linebreak)," error"==div.className.substr(div.className.length-6,6)?div.className=div.className.substr(0,div.className.length-6):"error"==div.className&&(div.className=""),!0},frequency_schedule:function(args){Ajax.call([{methodname:"block_learnerscript_frequency_schedule",args:{frequency:$("#id_frequency"+args.reportinstance).val()}}])[0].done((function(resp){resp=$.parseJSON(resp);var template="";resp?$.each(resp,(function(index,value){template+="<option value = "+index+" >"+value+"</option>"})):Str.get_string("selectall","block_reportdashboard").then((function(s){template+="<option value=null >"+s+"</option>"})),$("#id_updatefrequency"+args.reportinstance).html(template)})).fail((function(){}))},manageschusers:function(args){Str.get_strings([{key:"scheduled_user",component:"block_learnerscript"},{key:"close",component:"block_learnerscript"}]).then((function(s){Ajax.call([{methodname:"block_learnerscript_manageschusers",args:{reportid:args.reportid,scheduleid:args.scheduleid,selectedroleid:JSON.stringify(args.selectedroleid),schuserslist:args.schuserslist,reportinstance:args.reportinstance}}])[0].done((function(response){response=$.parseJSON(response),Templates.render("block_learnerscript/scheduledusers",response).done((function(html,js){var position,my,at;$("body").append("<div class='manageschusers'>"+html,js+"</div>"),"page-blocks-learnerscript-components-scheduler-schedule"==$("body").attr("id")?(position="#scheduleform",my="center top",at="center top"):(position=window,my="center",at="center");var dlg=$(".manageschusers").dialog({resizable:!0,autoOpen:!1,width:"60%",title:s[0],modal:!0,position:{my:my,at:at,of:position,within:position},close:function(){$(this).dialog("destroy").remove()},open:function(){$(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var Closebutton=$(".ui-icon-closethick").parent();$(Closebutton).attr({title:s[1]})}});$(".manageschusers").hasClass("notschuserspage")&&$(".manageschusers").parent().addClass("notinschpage");$(".selectrole"+args.reportid).select2(),dlg.dialog("open")}))})).fail((function(){}))}))},getroleusers:function(args){var roles=$(".selectrole"+args.reportid).val();this.validate_scheduled_reports_form({reportid:args.reportid,form:"assignform",reqclass:"rolereq"});var bullkselectedusers=$(".removeselect").val(),template="";if($("#addselect_searchtext").val().length<1)Str.get_string("enter_value_insearch","block_learnerscript").then((function(s){template="<optgroup label='"+s+"'></optgroup>"})),$("#"+args.type+"select"+args.reportid).html(template);else{var roleid=roles.split("_");args.roleid=roleid[0],args.contextlevel=roleid[1],Ajax.call([{methodname:"block_learnerscript_roleusers",args:{term:$("#addselect_searchtext").val(),type:args.type,reportid:args.reportid,roleid:args.roleid,contextlevel:args.contextlevel,scheduleid:args.scheduleid,bullkselectedusers:JSON.stringify(bullkselectedusers)}}])[0].done((function(response){var template="";(response=$.parseJSON(response)).total_count>0?$.each(response.items,(function(index,value){template+="<option value = "+value.id+" >"+value.fullname+"</option>"})):Str.get_string("no_result","block_learnerscript").then((function(s){template+="<optgroup label='"+s+"'></optgroup>"})),$("#"+args.type+"select"+args.reportid).html(template)})).fail((function(){}))}},bulkmanageschusers:function(args){var bullkselectedusers=$.map($(".removeselect option"),(function(e){return e.value}));$("#schuserslist"+args.reportinstance).val(bullkselectedusers);var selectedusers=$(".removeselect").find("option").clone();$("#id_users_data"+args.reportinstance).children("option").remove(),selectedusers.length>10?Str.get_string("viewmore","block_learnerscript").then((function(s){selectedusers.slice(0,10).attr("selected","selected").appendTo("#id_users_data"+args.reportinstance);var opt=document.createElement("option");opt.value="-1",opt.innerHTML=s,opt.selected=!0,document.getElementById("id_users_data"+args.reportinstance).appendChild(opt)})):$(".removeselect").find("option").clone().attr("selected","selected").appendTo("#id_users_data"+args.reportinstance),$(".manageschusers").dialog("close")},viewschusers:function(args){Str.get_strings([{key:"view_scheduled_users",component:"block_learnerscript"},{key:"close",component:"block_learnerscript"}]).then((function(s){args.schuserslist=$("#schuserslist"+args.reportinstance).val(),ajax.call({methodname:"viewschuserstable",args:{action:"viewschuserstable",reportid:args.reportid,scheduleid:args.scheduleid,schuserslist:args.schuserslist},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done((function(response){$("body").append("<div class='viewschuserstable'>"+response+"</div>");var dlg=$(".viewschuserstable").dialog({resizable:!0,autoOpen:!1,width:"60%",title:s[0],modal:!0,close:function(){$(this).dialog("destroy").remove()},open:function(){$(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var Closebutton=$(".ui-icon-closethick").parent();$(Closebutton).attr({title:s[1]})}});schedule.ViewSchUsersTable(args),dlg.dialog("open").prev(".ui-dialog-titlebar").css("color","#0C75B6")})).fail((function(){}))}))},addschusers:function(args){var total,selschusers=$(".schforms"+args.reportinstance+" #id_users_data"+args.reportinstance).val(),selusers=$(".schforms"+args.reportinstance+" #schuserslist"+args.reportinstance).val();if(selusers?(selusers=selusers.split(","),total=selusers.concat(selschusers)):total=selschusers,total&&total.includes("-1")){var index=total.indexOf("-1");total.splice(index,1)}$("#id_users_data"+args.reportinstance).find("option").not(":selected").each((function(k,v){if(total&&total.includes(v.value)){var index=total.indexOf(v.value);total.splice(index,1)}}));var d=total&&total.filter((function(item,pos){return total.indexOf(item)==pos}));$("#schuserslist"+args.reportinstance).val(d)},SelectRoleUsers:function(){var reportid=$(".schform").data("reportid");require(["block_learnerscript/helper"],(function(helper){helper.Select2Ajax({reportid:reportid,action:"rolewiseusers",maximumselectionlength:5})}))},rolewiseusers:function(args){$("#id_users_data"+args.reportinstance).val(null).trigger("change")}};return schedule}));

//# sourceMappingURL=schedule.min.js.map